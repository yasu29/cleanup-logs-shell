ログ削除運用シェル（擬似案件）
==============================

概要
----

本スクリプトは、指定したディレクトリ配下に存在する
一定日数以上前のログファイルを対象に、安全に削除を行うための
運用向けシェルスクリプトです。

cron からの定期実行を想定し、誤操作や二重起動を防止するための
仕組みをあらかじめ組み込んでいます。


主な機能
--------

- 指定ディレクトリ配下のファイルを対象に処理
- 指定日数より古いファイルを抽出
- dry-run（削除対象の確認のみ）対応
- 実行モード指定時のみ削除を実施
- 二重起動防止（ロックファイル方式）
- 実行ログの出力
- exit code による処理結果通知


実行環境
--------

- Linux（Ubuntu）
- bash
- cron 実行を想定

※ 特別なライブラリや追加パッケージは使用していません。


使用方法
--------

./cleanup_logs.sh <target_dir> <days> [dry-run | execute]


引数説明
--------

target_dir
    処理対象のディレクトリ

days
    何日以上前のファイルを削除対象とするか

dry-run
    削除は行わず、削除対象ファイルをログに出力のみ行います

execute
    実際に削除処理を実行します


実行例
------

削除対象の確認（dry-run）

./cleanup_logs.sh /var/log/myapp 30 dry-run

→ 削除対象となるファイル一覧をログに出力します。


削除を実行する場合（execute）

./cleanup_logs.sh /var/log/myapp 30 execute

→ 指定条件に合致したファイルを削除します。


実行ログのサンプル
------------------

以下は dry-run モードで実行した際のログ出力例です。

2026-01-31 16:51:11 [cleanup_logs.sh] ロック取得完了
2026-01-31 16:51:11 [cleanup_logs.sh] dry-run モードで実行します（削除は行いません）
2026-01-31 16:51:11 [cleanup_logs.sh] 処理開始
2026-01-31 16:51:11 [cleanup_logs.sh] MODE=dry-run
2026-01-31 16:51:11 [cleanup_logs.sh] TARGET_DIR=/var/log/myapp
2026-01-31 16:51:11 [cleanup_logs.sh] DAYS=30
2026-01-31 16:51:11 [cleanup_logs.sh] 削除対象ファイル数: 3
2026-01-31 16:51:11 [cleanup_logs.sh] 対象: /var/log/myapp/app.log.1
2026-01-31 16:51:11 [cleanup_logs.sh] 対象: /var/log/myapp/app.log.2
2026-01-31 16:51:11 [cleanup_logs.sh] 対象: /var/log/myapp/app.log.3
2026-01-31 16:51:11 [cleanup_logs.sh] dry-run のため削除は実行しません
2026-01-31 16:51:11 [cleanup_logs.sh] 処理正常終了


cron 実行例
------------

例：毎日 3:00 に dry-run で実行する場合

0 3 * * * /home/user/projects/cleanup_logs/cleanup_logs.sh /var/log/myapp 30 dry-run

例：毎日 3:00 に execute モードで実行する場合

0 3 * * * /home/user/projects/cleanup_logs/cleanup_logs.sh /var/log/myapp 30 execute

注意事項：

- cron では実行ユーザーの PATH が限定されるため、
  スクリプト内で PATH を固定しています
- 相対パスは使用せず、必ず絶対パスで指定してください
- ログはスクリプト配下の log/ ディレクトリに出力されます


exit code 設計
---------------

本スクリプトでは、以下の exit code を使用しています。

0
    正常終了

1
    一般的なエラー（想定外の失敗）

2
    引数不正（数・内容が仕様を満たしていない場合）

3
    二重起動検知（ロックファイル存在時）

cron や監視ツールから、
処理結果を exit code で判別できる設計としています。


安全対策について
----------------

- dry-run モードにより、事前に削除対象を確認可能
- 二重起動防止により、同時実行による事故を防止
- 削除処理は execute を明示的に指定した場合のみ実行


想定利用シーン
--------------

- アプリケーションログの定期削除
- ディスク容量圧迫の防止
- cron による夜間・定期メンテナンス処理


備考
----

本スクリプトは、
個人受注案件を想定した擬似案件として作成したものです。

実運用を意識し、
可読性・保守性・安全性を重視した構成としています。

